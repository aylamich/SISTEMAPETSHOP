<!DOCTYPE html>
<html lang="pt">

<script>
    let idUsuarioSelExclusao = null;
    let paginaAtual = 0;
    let registrosPorPagina = 3;
    let totalRegistrosConsulta = 0;

    function excluirUsuario(acao) {

      document.getElementById('overlay').style.display = 'none'; // Fechar o diálogo
      
      if (acao === 'sim') {
        fetch('/api/excluirusuario', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id:idUsuarioSelExclusao })
        }).then(data => {
            if (data.status == 400) {
                alert('Não foi possível excluir o usuário!');
            } else if (data.status == 200) {
                idUsuarioSelExclusao = null;            
                alert("Usuário excluído com sucesso!");
                window.location.reload(); // Recarrega a página
            }        
        }).catch(error =>alert("Erro ao excluir o usuário!"));

      } else {
        idUsuarioSelExclusao = null;
      }
    
    }

    function consultaUsuario() {
    
        fetch('/api/consultausuario', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ paginaAtual, registrosPorPagina })
        })
            .then(response => response.json()).then(data => {
                console.log(data[0]);

                data[0].forEach(usuario => {

                  /*console.log(usuario.nomeCompleto)
                  console.log(usuario.email)
                  console.log(usuario.senha)
                  console.log(usuario.tipoCliente)*/

                  const tabelaUsuario = document.getElementById('tabelaUsuario').getElementsByTagName('tbody')[0];

                  const row = tabelaUsuario.insertRow();  // Cria uma nova linha

                  // Cria e insere células na linha
                  const cellNomeCompleto = row.insertCell(0);
                  const cellEmail = row.insertCell(1);
                  const cellTipoUsuario = row.insertCell(2);
                  const cellAcao = row.insertCell(3);

                  
                  // Preenche as células com os dados retornados
                  cellNomeCompleto.textContent = usuario.nomeCompleto;
                  cellEmail.textContent = usuario.email;
                  cellTipoUsuario.textContent = usuario.tipoUsuario;
                 
                  const btnEditar = document.createElement('button');
                  btnEditar.className = 'btn-editar';
                  btnEditar.addEventListener('click', () => {
                    editarUsuario(usuario.id); 
                  });

                  const imgEditar = document.createElement('img');
                  imgEditar.src = 'pencil.png';
                  imgEditar.style.width = '20px'; 
                  imgEditar.style.height = '20px';

                  btnEditar.appendChild(imgEditar);
              
    
                  const btnExcluir = document.createElement('button');
                  btnExcluir.className = 'btn-excluir';
                  btnExcluir.addEventListener('click', () => {
                    idUsuarioSelExclusao = usuario.id;
                    mostrarAlertaExclusao(); 
                });
              
                const imgExcluir = document.createElement('img');
                imgExcluir.src = 'trash.png'; 
                imgExcluir.style.width = '20px'; 
                imgExcluir.style.height = '20px'; 

                btnExcluir.appendChild(imgExcluir);
                
                  cellAcao.appendChild(btnEditar);
                  cellAcao.appendChild(btnExcluir);
          
                  });
            }).catch(error => console.error('Erro:', error));
    }
    
    function mostrarAlertaExclusao() {
        document.getElementById('overlay').style.display = 'flex';
      }

    function editarUsuario(id) {
        window.location.href = `cadastrousuario.html?id=${id}`;
    }
    
    function limparConteudo() {
        var tabela = document.getElementById("tabelaUsuario").getElementsByTagName('tbody')[0];
        
        while (tabela.rows.length > 0) {
          tabela.deleteRow(0);
      }
    }
  
      function primeiraPagina() {
        pesquisarTotalRegistros();
        limparConteudo()
        paginaAtual = 0;
        consultaUsuario();
  
      }
      async function proximaPagina() {
        await pesquisarTotalRegistros();
        paginaAtual = paginaAtual + registrosPorPagina;
  
        if(parseInt(paginaAtual) == parseInt(totalRegistrosConsulta)){
            /* Se entrou nesta condição é porque a pagina atual é a ultima, sendo assim a variavel paginaAtual não deve ser incrementada, devido a isso é executado a subtração para a variavel voltar ao seu valor anterior */
            paginaAtual = paginaAtual - registrosPorPagina;
        } else if (paginaAtual > totalRegistrosConsulta) {
            /* Se entrou nesta condição, é porque a quantidade de registros da proxima página é menor que a quantidade total de registros listados em cada página */
            limparConteudo();
            let paginaComConteudoParcial = totalRegistrosConsulta / registrosPorPagina;
            if (paginaComConteudoParcial > 0) {
                let parteInteira = Math.floor(paginaComConteudoParcial); 
                paginaAtual = parteInteira * registrosPorPagina;      
                consultaUsuario();
            }
        } else if ( parseInt(paginaAtual) < parseInt(totalRegistrosConsulta)) {
            /*Se entrou nesta condição, é porque a página atual é menor que o total de registros, ou seja, irá continuar a paginação sequencial */
          limparConteudo();
          consultaUsuario(); 
        }
        
      }
      async function ultimaPagina() {
        await pesquisarTotalRegistros();
        
        if(parseInt(paginaAtual) != parseInt(totalRegistrosConsulta)){

            let paginaComConteudoParcial = totalRegistrosConsulta / registrosPorPagina;
            if (paginaComConteudoParcial > 0) {

                if(paginaComConteudoParcial % 1 == 0){                   
                    /*Se entrou nesta condição é porque o numero total de registros divido pela quantidade de registros por página corresponte a um numero inteiro, ou seja, se a paginação for de 10 em 10, significa que a ultima pagina possui 10 registros*/
                    let parteInteira = Math.floor(paginaComConteudoParcial); 
                    paginaAtual = parteInteira * registrosPorPagina;
                    paginaAtual = totalRegistrosConsulta - registrosPorPagina;
                } else {
                    /*Se entrou nesta condição é porque o numero total de registros divido pela quantidade de registros por página corresponte a um numero decimal, ou seja, se a paginação for de 10 em 10, significa que a ultima pagina menos de 10 registros e devido a isso é necessário calcular o valor paginaAtual*/
                    let parteInteira = Math.floor(paginaComConteudoParcial); 
                    paginaAtual = parteInteira * registrosPorPagina;
                }                                 
          
        limparConteudo();
        consultaUsuario();
        }
      }
    }

      function paginaAnterior() {
       paginaAtual = paginaAtual - registrosPorPagina;
        if (paginaAtual < 0) {
          paginaAtual = 0;
        } else if (paginaAtual >= 0) {
      limparConteudo()
      consultaUsuario();
      }
    }

      function pesquisarTotalRegistros() {
        fetch('/api/pesquisartotalregistrosusuario', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        }).then(response => response.json()).then(data => {
          totalRegistrosConsulta = data[0][0].total;
        }).catch(error => console.error('Erro:', error));
      }

    document.addEventListener('DOMContentLoaded', function () {
        primeiraPagina();
        const tipoUsuario = sessionStorage.getItem('tipoUsuario');
        //alert(tipoUsuario);
        if (tipoUsuario == 'admin') {
          document.getElementById('telaUsuario').style.display = 'inline-block';;
          document.getElementById('telaAgenda').style.display = 'inline-block';;
          document.getElementById('telaAnimal').style.display = 'inline-block';;
          document.getElementById('telaCliente').style.display = 'inline-block';;
        } else if (tipoUsuario == 'cliente') {
          document.getElementById('telaUsuario').style.display = 'none';
          document.getElementById('telaAgenda').style.display = 'none';
          document.getElementById('telaAnimal').style.display = 'none';
          document.getElementById('telaCliente').style.display = 'none';        
        } else {
          document.getElementById('telaUsuario').style.display = 'none';
          document.getElementById('telaAgenda').style.display = 'inline-block';;
          document.getElementById('telaAnimal').style.display = 'inline-block';;
          document.getElementById('telaCliente').style.display = 'inline-block';;
        }
      });

      function sair() {
        sessionStorage.clear();
        window.location.href = '/petshop.html';
    }

</script>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta Usuários</title>
    <link rel="stylesheet" href="consultausuario.css">
</head>
<body>
    <div class="navbar">
        <a href="funcionario.html">Home</a>
        <a id="telaCliente" href="consultacliente.html">Cliente</a>
        <a id="telaAnimal" href="consultaanimal.html">Animal</a>
        <a id="telaAgenda" href="agenda.html">Agenda</a>
        <a id="telaUsuario" href="consultausuario.html">Usuário</a>
        <a onclick="sair()">Sair</a>
    </div>

        <h2>USUÁRIOS</h2>

        <div class="overlay" id="overlay">
            <div class="dialog-box">
                <p>Você tem certeza que deseja excluir esse usuário?</p>
                <button id="sim" onclick="excluirUsuario('sim')">Sim</button>
                <button id="nao" onclick="excluirUsuario('nao')">Não</button>
            </div>
          </div>

        <table align="center" id="tabelaUsuario">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Email</th>
                    <th>Tipo de usuário</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                
            </tbody>
        </table>

        <div class="container">

            <div class="paginacao">
                <p class="descricao">Paginação</p>
                <button class="botao-imagem" onclick="primeiraPagina()" type="button">
                    <img src="2flechaesquerda.png" alt="Imagem 1">
                </button>
                <button class="botao-imagem"  onclick="paginaAnterior()" type="button">
                    <img src="flechaesquerda.png" alt="Imagem 2">
                </button>
                <button class="botao-imagem" onclick="proximaPagina()" type="button">
                    <img src="flechadireita.png" alt="Imagem 3">
                </button>
                <button class="botao-imagem" onclick="ultimaPagina()" type="button">
                    <img src="2flechadireita.png" alt="Imagem 4">
                </button>
            </div>

        <div class="adicionar">
          <button class="botao" type="submit" onclick="window.location.href='cadastrousuario.html'">Adicionar Usuário</button>
      </div>
  </div>

</body>
</html>